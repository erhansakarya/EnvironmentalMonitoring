#include "main.h"
#include "cmsis_os.h"

#include "envmonitor.h"
#include "tsl2561.h"

envmonitor_s envmonitor = INIT_ENVMONITOR;

/* Private variables ---------------------------------------------------------*/
I2C_HandleTypeDef hi2c1;
UART_HandleTypeDef huart2;

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_USART2_UART_Init(void);
static void MX_I2C1_Init(void);

uint8_t ENVMNTR_init(void){

	uint8_t error = 0;

	/* Reset of all peripherals, Initializes the Flash interface and the Systick. */
	HAL_Init();

	/* Configure the system clock */
	SystemClock_Config();

	/* Initialize all configured peripherals */
	MX_GPIO_Init();
	MX_USART2_UART_Init();
	MX_I2C1_Init();

	error = TSL2561_init();

	return error;

}

uint8_t ENVMNTR_createTasks(void){

	uint8_t error = 0;

	TaskHandle_t TSL2561_handler = NULL;
	TaskHandle_t htu21dHandler = NULL;

	/* Create tasks */
	if(pdPASS != xTaskCreate(TSL2561_handler, "TSL2561_handler",
					configMINIMAL_STACK_SIZE, (void *)&envmonitor.sensor.tsl2561.lux,
					configMAX_PRIORITIES - 1, TSL2561_handler)){

		  return -1;
	}

	/* Start the scheduler so the tasks start executing. */
	vTaskStartScheduler();

	return error;

}
